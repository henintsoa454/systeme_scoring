{% extends base_template %}
{% block content %}
{% load static %}

<link rel="stylesheet" href="{% static 'css/performance_generale.css' %}">

<div class="chart-container">
    <h3>Montants empruntés vs. Remboursements reçus</h3>
    <div id="filters" class="filter">
        <span>
            <label for="year">Année:</label>
            <select id="year">
                <option value="">Toutes les années</option>
                {% for y in years %}
                    <option value="{{ y }}" {% if y == year %}selected{% endif %}>{{ y }}</option>
                {% endfor %}
            </select>
        </span>

        <span>
            <label for="month">Mois:</label>
            <select id="month">
                <option value="">Tous les mois</option>
                <option value="1">Janvier</option>
                <option value="2">Février</option>
                <option value="3">Mars</option>
                <option value="4">Avril</option>
                <option value="5">Mai</option>
                <option value="6">Juin</option>
                <option value="7">Juillet</option>
                <option value="8">Août</option>
                <option value="9">Septembre</option>
                <option value="10">Octobre</option>
                <option value="11">Novembre</option>
                <option value="12">Décembre</option>
            </select>
        </span>
    </div>
    <canvas id="empruntsRemChart"></canvas>
    
    <!-- Ajout des totaux -->
    <div class="totals-container">
        <div class="total-box">
            <span class="total-label">Total emprunts:</span>
            <span id="total-emprunts" class="total-value">0 MGA</span>
        </div>
        <div class="total-box">
            <span class="total-label">Total remboursements:</span>
            <span id="total-remboursements" class="total-value">0 MGA</span>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    let empruntsRemChartInstance = null;

    async function fetchPerformanceData() {
        const year = document.getElementById("year").value;
        const month = document.getElementById("month").value;

        try {
            const response = await fetch(`/api/get_performance_generale/?year=${year}&month=${month}`);
            if (response.ok) {
                const data = await response.json();

                if (data.emprunts_vs_remboursements) {
                    updateEmpruntsRemChart(data.emprunts_vs_remboursements);
                    updateTotals(data.emprunts_vs_remboursements);
                } else {
                    console.error("Données invalides reçues du serveur.");
                }
            } else {
                console.error("Erreur lors de la récupération des données : ", response.statusText);
            }
        } catch (error) {
            console.error("Erreur réseau :", error);
        }
    }

    function updateTotals(data) {
        // Calcul des totaux
        const totalEmprunts = data.emprunts.reduce((a, b) => a + b, 0);
        const totalRemboursements = data.remboursements.reduce((a, b) => a + b, 0);
        
        // Mise à jour de l'affichage
        document.getElementById("total-emprunts").textContent = 
            totalEmprunts.toLocaleString('fr-FR') + ' MGA';
        document.getElementById("total-remboursements").textContent = 
            totalRemboursements.toLocaleString('fr-FR') + ' MGA';
    }

    function updateEmpruntsRemChart(data) {
        const year = document.getElementById("year").value;
        const month = document.getElementById("month").value;
    
        const xAxisTitle = month ? "Jours du mois" : 
                      year ? "Mois de l'année" : "Périodes";
        const ctx = document.getElementById("empruntsRemChart").getContext("2d");
        
        if (empruntsRemChartInstance) {
            empruntsRemChartInstance.destroy();
        }
        
        empruntsRemChartInstance = new Chart(ctx, {
            type: "line",
            data: {
                labels: data.labels || [],
                datasets: [
                    {
                        label: "Emprunts",
                        data: data.emprunts || [],
                        borderColor: "rgba(229, 0, 5, 1)",
                        backgroundColor: "rgba(229, 0, 5, 0.2)",
                        tension: 0.4,
                        fill: true
                    },
                    {
                        label: "Remboursements",
                        data: data.remboursements || [],
                        borderColor: "rgba(159, 160, 162, 1)",
                        backgroundColor: "rgba(159, 160, 162, 0.2)",
                        tension: 0.4,
                        fill: true
                    }
                ]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        position: "top"
                    },
                    title: {
                        display: true,
                        text: "Montants empruntés vs. Remboursements"
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return `${context.dataset.label}: ${context.raw.toLocaleString('fr-FR')} MGA`;
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        title: {
                            display: true,
                            text: xAxisTitle
                        }
                    },
                    y: {
                        title: {
                            display: true,
                            text: "Montant (MGA)"
                        },
                        ticks: {
                            callback: function(value) {
                                return value.toLocaleString('fr-FR');
                            }
                        }
                    }
                }
            }
        });
    }

    document.getElementById("filters").addEventListener("change", fetchPerformanceData);

    fetchPerformanceData();
</script>

<style>
    .totals-container {
        display: flex;
        justify-content: space-around;
        margin-top: 20px;
        padding: 15px;
        background-color: #f5f5f5;
        border-radius: 5px;
    }
    
    .total-box {
        text-align: center;
    }
    
    .total-label {
        display: block;
        font-weight: bold;
        color: #333;
    }
    
    .total-value {
        font-size: 1.2em;
        color: #e50005;
    }
    
    .total-value:nth-child(2) {
        color: #9fa0a2;
    }
</style>

{% endblock %}