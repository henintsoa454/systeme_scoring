{% extends base_template %}
{% block content %}
{% load static %}

<link rel="stylesheet" href="{% static 'fontawesome-5/css/all.css' %}">
<link rel="stylesheet" href="{% static 'css/resume_demande.css' %}">

<div class="container demande-container">
    <div class="header-section">
        <h1 class="page-title">
            <i class="fas fa-file-invoice-dollar"></i>Résumé de la demande de crédit
        </h1>
        <div class="demande-header-card">
            <div class="row">
                <div class="col-md-6">
                    <p><strong>N° Demande:</strong> {{ demande.numero_credit }}</p>
                    <p><strong>Date:</strong> {{ demande.date_demande|date:"d/m/Y" }}</p>
                    <p><strong>Statut:</strong> {{ demande.get_statut_display }}</p>
                </div>
                <div class="col-md-6 text-end">
                    <p><strong>Type de crédit:</strong> {{ demande.sous_type_credit }}</p>
                    <p><strong>Agence:</strong> {{ demande.agence.adresse }}</p>
                    <p><strong>Analyste de l'approbation :</strong> {{ demande.traite_par.nom }} {{ demande.traite_par.prenom }}</p>
                </div>
            </div>
        </div>
    </div>

    <div class="grid-container">
        <!-- Section Informations Client -->
        <div class="grid-card">
            <div class="card info-card">
                <div class="card-header client-header">
                    <i class="fas fa-user-tie"></i>Informations Client
                </div>
                <div class="card-body">
                    <div class="client-photo">
                        <i class="fas fa-user-circle"></i>
                    </div>
                    <div class="client-details">
                        <p><strong>Nom complet:</strong> {{ demande.client.nom }} {{ demande.client.prenom }}</p>
                        <p><strong>CIN:</strong> {{ demande.client.n_cin }}</p>
                        <p><strong>Date naissance:</strong> {{ demande.client.date_naissance|date:"d/m/Y" }} ({{ demande.client.age }} ans)</p>
                        <p><strong>Situation familiale:</strong> {{ demande.client.get_statut_familial_display }}</p>
                        <p><strong>Dépendants:</strong> {{ demande.client.nbr_dependant }}</p>
                        <p><strong>Téléphone:</strong> {{ demande.client.numero_telephone }}</p>
                        <p><strong>Adresse:</strong> {{ demande.client.adresse }}</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Section Détails Crédit -->
        <div class="grid-card">
            <div class="card info-card">
                <div class="card-header credit-header">
                    <i class="fas fa-money-bill-wave"></i>Détails du Crédit
                </div>
                <div class="card-body">
                    <div class="credit-summary">
                        <div class="summary-item">
                            <span class="summary-label">Montant demandé</span>
                            <span class="summary-value">{{ demande.montant_total }} MGA</span>
                        </div>
                        <div class="summary-item">
                            <span class="summary-label">Durée</span>
                            <span class="summary-value">{{ demande.duree }} mois</span>
                        </div>
                        <div class="summary-item">
                            <span class="summary-label">Taux d'intérêt</span>
                            <span class="summary-value">{{ demande.sous_type_credit.taux_interet }}%</span>
                        </div>
                        <div class="summary-item">
                            <span class="summary-label">Mensualité</span>
                            <span class="summary-value">{{ demande.montant_payer_mois }} MGA/mois</span>
                        </div>
                        <div class="summary-item">
                            <span class="summary-label">Motif</span>
                            <span class="summary-value">{{ demande.motif_credit }}</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Section Situation Financière -->
        <div class="grid-card">
            <div class="card info-card">
                <div class="card-header finance-header">
                    <i class="fas fa-chart-pie"></i>Situation Financière
                </div>
                <div class="card-body">
                    <div class="finance-item">
                        <i class="fas fa-wallet"></i>
                        <div>
                            <h5>Revenu mensuel</h5>
                            <p>{{ demande.client.revenu_mensuel }} MGA</p>
                        </div>
                    </div>
                    <div class="finance-item">
                        <i class="fas fa-shopping-cart"></i>
                        <div>
                            <h5>Dépenses mensuelles</h5>
                            <p>{{ demande.client.depense_mensuelles }} MGA</p>
                        </div>
                    </div>
                    <div class="finance-item">
                        <i class="fas fa-hand-holding-usd"></i>
                        <div>
                            <h5>Dettes existantes</h5>
                            <p>{{ demande.client.dettes_existantes }} MGA</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Section Professionnelle et Bancaire -->
        <div class="grid-card">
            <div class="card info-card">
                <div class="card-header finance-header">
                    <i class="fas fa-briefcase"></i>Situation Professionnelle & Bancaire
                </div>
                <div class="card-body">
                    <div class="finance-item">
                        <i class="fas fa-briefcase"></i>
                        <div>
                            <h5>Situation professionnelle</h5>
                            <p>{{ demande.client.get_situation_professionnelle_display }}</p>
                        </div>
                    </div>
                    <div class="finance-item">
                        <i class="fas fa-university"></i>
                        <div>
                            <h5>Situation bancaire</h5>
                            <p>{{ demande.client.get_situation_bancaire_display }}</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="action-buttons">
        <a href="{% url 'preview_contract' demande.id %}" class="btn preview-btn" target="_blank">
            <i class="fas fa-eye"></i> Prévisualiser
        </a>
        <button type="button" class="btn generate-btn" id="generateContractBtn" data-url="{% url 'generate_contract' demande.id %}">
            <i class="fas fa-file-contract"></i> Générer le contrat
        </button>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const generateBtn = document.getElementById('generateContractBtn');
        
        if(generateBtn) {
            generateBtn.addEventListener('click', function() {
                this.disabled = true;
                this.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Génération en cours...';
                
                fetch(this.dataset.url)
                    .then(response => {
                        if(response.ok) {
                            window.location.href = "{% url 'pdf_download_complete' %}?demande_id={{ demande.id }}";
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        this.disabled = false;
                        this.innerHTML = '<i class="fas fa-file-contract"></i> Générer le contrat';
                    });
            });
        }
    });
    </script>

{% endblock %}