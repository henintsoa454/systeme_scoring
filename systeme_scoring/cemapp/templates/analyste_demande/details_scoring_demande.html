{% extends base_template %}
{% block content %}
{% load static %}

<link rel="stylesheet" href="{% static 'css/details_scoring_demande.css' %}">

<div class="details-container">
    <h1>Détails du Scoring de la Demande</h1>
    <div class="clientcredit">
        <table class="details-table">
            <tr>
                <th>Nom</th>
                <td>{{ client.nom }}</td>
            </tr>
            <tr>
                <th>Prénom</th>
                <td>{{ client.prenom }}</td>
            </tr>
            <tr>
                <th>Date de Naissance</th>
                <td>{{ client.date_naissance }}</td>
            </tr>
            <tr>
                <th>Email</th>
                <td>{{ client.email }}</td>
            </tr>
            <tr>
                <th>Adresse</th>
                <td>{{ client.adresse }}</td>
            </tr>
        </table>
        <table class="details-table">
            <tr>
                <th>Montant Total</th>
                <td>{{ demande.montant_total }}</td>
            </tr>
            <tr>
                <th>Taux d'Intérêt</th>
                <td>{{ demande.sous_type_credit.taux_interet }}</td>
            </tr>
            <tr>
                <th>Type de Crédit</th>
                <td>{{ demande.sous_type_credit.nom }}</td>
            </tr>
        </table>
    </div>
    <div class="familiale score-card">
        <h2>Situation familiale</h2>
        <div class="score-value">{{ scores.situation_familiale|floatformat:0 }}/100</div>
        <div class="score-bar">
            <div class="bar-fill" style="width: {{ scores.situation_familiale }}%"></div>
        </div>
        <div class="score-tooltip">
            <h3>Critères évalués :</h3>
            <ul>
                <li>État civil : {{ client.statut_familial }}</li>
                <li>Nombre de dépendant : {{ client.nbr_dependant }}</li>
                <li>Age : {{ client.age }}</li>
            </ul>
        </div>
    </div>
    
    <div class="professionnelle score-card">
        <h2>Situation professionnelle</h2>
        <div class="score-value">{{ scores.situation_professionnelle|floatformat:0 }}/100</div>
        <div class="score-bar">
            <div class="bar-fill" style="width: {{ scores.situation_professionnelle }}%"></div>
        </div>
    </div>
    
    <div class="financiere score-card">
        <h2>Situation financière</h2>
        <div class="score-value">{{ scores.situation_financiere|floatformat:0 }}/100</div>
        <div class="score-bar">
            <div class="bar-fill" style="width: {{ scores.situation_financiere }}%"></div>
        </div>
    </div>
    
    <div class="capaciteremboursement score-card">
        <h2>Capacité de remboursement</h2>
        <div class="score-text">{{ scores.capacite_remboursement }}</div>
        <div class="score-tooltip">
            <h3>Critères évalués :</h3>
            <ul>
                <li>Revenu mensuel du client : {{ client.revenu_mensuel }} MGA</li>
                <li>Dépense mensuel du client : {{ client.depense_mensuelles }} MGA</li>
                <li>Dettes existantes : {{ client.dettes_existantes }} MGA</li>
                <li>Montant demandé : {{ demande.montant_total }} MGA</li>
                <li>Taux du crédit : {{ demande.sous_type_credit.taux_interet }} %</li>
            </ul>
        </div>
    </div>
    
    <div class="inspectionenvironnement score-card">
        <h2>Inspection de l'environnement</h2>
        <div class="score-value">{{ scores.inspection_environnement|floatformat:0|default:'-' }}/100</div>
        {% if scores.inspection_environnement %}
        <div class="score-bar">
            <div class="bar-fill" style="width: {{ scores.inspection_environnement|floatformat:0 }}%"></div>
        </div>
        {% else %}
        <div class="score-missing">Non renseigné</div>
        {% endif %}
    </div>
    
    <div class="ponctualite score-card">
        <h2>Ponctualité</h2>
        <table>
            <tr>
                <td><strong>Score :</strong></td>
                <td>{{ scores.ponctualite.score }}</td>
            </tr>
            <tr>
                <td><strong>Niveau :</strong></td>
                <td>{{ scores.ponctualite.niveau }}</td>
            </tr>
            <tr>
                <td><strong>Taux retards :</strong></td>
                <td>{{ scores.ponctualite.taux_retards }}%</td>
            </tr>
            <tr>
                <td><strong>Retard moyen :</strong></td>
                <td>{{ scores.ponctualite.retard_moyen }}</td>
            </tr>
        </table>
    </div>
    <div class="score-global score-card">
        <h2>Score Global</h2>
        <div class="score-value">{{ score_general|floatformat:0 }}/100</div>
        <div class="score-bar">
            <div class="bar-fill" style="width: {{ score_general }}%"></div>
        </div>
        <div class="score-interpretation">
            {% if score_general >= 80 %}
                <span class="badge excellent">Excellent</span>
                <p>Le profil du client présente un risque très faible. Approbation recommandée.</p>
            {% elif score_general >= 60 %}
                <span class="badge bon">Bon</span>
                <p>Le profil du client présente un risque modéré. Approbation possible </p>
            {% elif score_general >= 40 %}
                <span class="badge moyen">Moyen</span>
                <p>Le profil du client présente un risque élevé. Approbation possible mais peux représenter un risque</p>
            {% else %}
                <span class="badge faible">Faible</span>
                <p>Le profil du client présente un risque très élevé. Refus recommandé.</p>
            {% endif %}
        </div>
    </div>
    <div class="action-buttons">
        <button class="btn btn-primary" onclick="window.location.href='{% url 'transmettre_demande' demande.id%}'">Transmettre au Directeur de l'agence</button>
        <button class="btn btn-danger" id="openRefusModal">Refuser la Demande</button>
    </div>
</div>
<div class="modal" id="modalRefus">
    <div class="modal-content">
        <span class="close" id="closeRefusModal">&times;</span>
        <h2>Raison du Refus</h2>
        <form id="refusForm" method="post" action="{% url 'refus_demande' demande.id%}">
            {% csrf_token %}
            <div class="form-group">
                <label for="raisonRefus">Veuillez indiquer la raison du refus :</label>
                <textarea class="form-control" id="raisonRefus" name="raison_refus" required rows="5"></textarea>
            </div>
            <button type="submit" class="btn btn-danger">Confirmer le refus</button>
        </form>
    </div>
</div>
<script>
    const openRefusModal = document.getElementById('openRefusModal');
    const closeRefusModal = document.getElementById('closeRefusModal');
    const modalRefus = document.getElementById('modalRefus');
    
    openRefusModal.addEventListener('click', () => {
        modalRefus.style.display = 'block';
    });
    
    closeRefusModal.addEventListener('click', () => {
        modalRefus.style.display = 'none';
    });
    
    window.addEventListener('click', function(event) {
        if (event.target === modalRefus) {
            modalRefus.style.display = 'none';
        }
    });

    document.getElementById('refusForm').addEventListener('submit', function(e) {
        e.preventDefault();
        
        fetch(this.action, {
            method: 'POST',
            body: new FormData(this),
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(data.message);
                modalRendezVous.style.display = 'none';
                location.reload();
            } else {
                alert('Erreur: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Une erreur est survenue');
        });
    });
</script>

{% endblock %}
    