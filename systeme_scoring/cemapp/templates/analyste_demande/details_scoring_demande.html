{% extends base_template %}
{% block content %}
{% load static %}

<link rel="stylesheet" href="{% static 'css/details_scoring_demande.css' %}">

<div class="details-container">
    <h1>Détails du Scoring de la Demande</h1>
    <div class="clientcredit">
        <table class="details-table">
            <tr>
                <th>Nom</th>
                <td>{{ client.nom }}</td>
            </tr>
            <tr>
                <th>Prénom</th>
                <td>{{ client.prenom }}</td>
            </tr>
            <tr>
                <th>Date de Naissance</th>
                <td>{{ client.date_naissance }}</td>
            </tr>
            <tr>
                <th>Email</th>
                <td>{{ client.email }}</td>
            </tr>
            <tr>
                <th>Adresse</th>
                <td>{{ client.adresse }}</td>
            </tr>
        </table>
        <table class="details-table">
            <tr>
                <th>Montant Total</th>
                <td>{{ demande.montant_total }}</td>
            </tr>
            <tr>
                <th>Taux d'Intérêt</th>
                <td>{{ demande.sous_type_credit.taux_interet }}</td>
            </tr>
            <tr>
                <th>Type de Crédit</th>
                <td>{{ demande.sous_type_credit.nom }}</td>
            </tr>
        </table>
    </div>
    <div class="familiale score-card">
        <h2>Situation familiale</h2>
        <div class="score-value">{{ scores.situation_familiale|floatformat:0 }}/100</div>
        <div class="score-bar">
            <div class="bar-fill" style="width: {{ scores.situation_familiale }}%"></div>
        </div>
        <div class="score-tooltip">
            <h3>Critères évalués :</h3>
            <ul>
                <li>État civil : {{ client.statut_familial }}</li>
                <li>Nombre de dépendant : {{ client.nbr_dependant }}</li>
                <li>Age : {{ client.age }}</li>
            </ul>
        </div>
    </div>
    
    <div class="professionnelle score-card">
        <h2>Situation professionnelle</h2>
        <div class="score-value">{{ scores.situation_professionnelle|floatformat:0 }}/100</div>
        <div class="score-bar">
            <div class="bar-fill" style="width: {{ scores.situation_professionnelle }}%"></div>
        </div>
    </div>
    
    <div class="financiere score-card">
        <h2>Situation financière</h2>
        <div class="score-value">{{ scores.situation_financiere|floatformat:0 }}/100</div>
        <div class="score-bar">
            <div class="bar-fill" style="width: {{ scores.situation_financiere }}%"></div>
        </div>
    </div>
    
    <div class="capaciteremboursement score-card">
        <h2>Capacité de remboursement</h2>
        <div class="score-text">{{ scores.capacite_remboursement }}</div>
    </div>
    
    <div class="inspectionenvironnement score-card">
        <h2>Inspection de l'environnement</h2>
        <div class="score-value">{{ scores.inspection|default:'-' }}</div>
        {% if scores.inspection %}
        <div class="score-bar">
            <div class="bar-fill" style="width: {{ scores.inspection }}%"></div>
        </div>
        <div class="score-label">{{ scores.inspection|floatformat:0 }}/100</div>
        {% else %}
        <div class="score-missing">Non renseigné</div>
        {% endif %}
    </div>
    
    <div class="ponctualite score-card">
        <h2>Ponctualité</h2>
        <table>
            <tr>
                <td><strong>Score :</strong></td>
                <td>{{ scores.ponctualite.score }}</td>
            </tr>
            <tr>
                <td><strong>Niveau :</strong></td>
                <td>{{ scores.ponctualite.niveau }}</td>
            </tr>
            <tr>
                <td><strong>Taux retards :</strong></td>
                <td>{{ scores.ponctualite.taux_retards }}%</td>
            </tr>
            <tr>
                <td><strong>Retard moyen :</strong></td>
                <td>{{ scores.ponctualite.retard_moyen }}</td>
            </tr>
        </table>
    </div>
    <div class="action-buttons">
        <button class="btn btn-primary" id="openRendezVousModal">Planifier un Rendez-vous</button>
        <button class="btn btn-danger" id="openRefusModal">Refuser la Demande</button>
    </div>
</div>
<div class="modal" id="modalRendezVous">
    <div class="modal-content">
        <span class="close" id="closeRendezVousModal">&times;</span>
        <h2>Planifier un Rendez-vous</h2>
        <form method="post" action="#">
            {% csrf_token %}
            <div class="form-group">
                <label for="id_date_debut_rendezvous">Date de début</label>
                <input type="datetime-local" id="id_date_debut_rendezvous" name="date_debut_rendezvous" required>
            </div>
            <div class="form-group">
                <label for="id_date_fin_rendezvous">Date de fin</label>
                <input type="datetime-local" id="id_date_fin_rendezvous" name="date_fin_rendezvous" required>
            </div>
            <div class="form-group">
                <label for="id_lieu">Lieu</label>
                <input type="text" id="id_lieu" name="lieu" required>
            </div>
            <button type="submit" class="btn btn-submit">Enregistrer le rendez-vous</button>
        </form>
    </div>
</div>

<div class="modal" id="modalRefus">
    <div class="modal-content">
        <span class="close" id="closeRefusModal">&times;</span>
        <h2>Raison du Refus</h2>
        <form id="refusForm">
            <div class="form-group">
                <label for="raisonRefus" class="form-label">Raison du Refus</label>
                <select class="form-select" id="raisonRefus" required>
                    <option value="score_inferieur">Score trop faible</option>
                    <option value="dossier_incomplet">Dossier incomplet</option>
                    <option value="autre">Autre</option>
                </select>
            </div>
            <div class="form-group" id="autreRaison" style="display: none;">
                <label for="detailsRefus" class="form-label">Détails supplémentaires</label>
                <textarea class="form-control" id="detailsRefus"></textarea>
            </div>
            <button type="submit" class="btn btn-danger">Refuser</button>
        </form>
    </div>
</div>
<script>
    document.querySelectorAll('.score-card').forEach(card => {
        card.addEventListener('click', (e) => {
            e.stopPropagation();
        });
    });
    
    const openRendezVousModal = document.getElementById('openRendezVousModal');
    const closeRendezVousModal = document.getElementById('closeRendezVousModal');
    const modalRendezVous = document.getElementById('modalRendezVous');
    
    const openRefusModal = document.getElementById('openRefusModal');
    const closeRefusModal = document.getElementById('closeRefusModal');
    const modalRefus = document.getElementById('modalRefus');
    
    openRendezVousModal.addEventListener('click', () => {
        modalRendezVous.style.display = 'block';
    });
    
    closeRendezVousModal.addEventListener('click', () => {
        modalRendezVous.style.display = 'none';
    });
    
    openRefusModal.addEventListener('click', () => {
        modalRefus.style.display = 'block';
    });
    
    closeRefusModal.addEventListener('click', () => {
        modalRefus.style.display = 'none';
    });
    
    document.getElementById('raisonRefus').addEventListener('change', function() {
        const autreRaison = document.getElementById('autreRaison');
        if (this.value === 'autre') {
            autreRaison.style.display = 'block';
        } else {
            autreRaison.style.display = 'none';
        }
    });

    window.addEventListener('click', function(event) {
        if (event.target === modalRendezVous) {
            modalRendezVous.style.display = 'none';
        }
        if (event.target === modalRefus) {
            modalRefus.style.display = 'none';
        }
    });
</script>

{% endblock %}
    