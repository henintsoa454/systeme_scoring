{% extends base_template %}
{% block content %}
{% load static %}

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

<style>
    :root {
        --primary-color: #e50005;
        --secondary-color: #9d9ea0;
        --light-bg: #e3e4e6;
        --dark-text: #2c3e50;
    }
    
    .compact-container {
        width: 95%;
        max-width: 1200px;
        margin: 20px auto;
        padding: 15px;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        height: calc(100vh - 100px);
        display: flex;
        flex-direction: column;
    }
    
    h1 {
        color: var(--dark-text);
        text-align: center;
        margin: 0 0 15px 0;
        font-size: 1.5rem;
        padding-bottom: 10px;
        border-bottom: 2px solid var(--primary-color);
    }
    
    .control-row {
        display: flex;
        gap: 15px;
        align-items: center;
        justify-content: center;
        margin-bottom: 15px;
        flex-wrap: wrap;
    }
    
    label {
        font-weight: 600;
        color: var(--dark-text);
        white-space: nowrap;
    }
    
    select {
        padding: 8px 12px;
        border: 1px solid var(--secondary-color);
        border-radius: 5px;
        background-color: white;
        font-size: 14px;
        min-width: 200px;
    }
    
    .btn {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        padding: 8px 16px;
        border: none;
        border-radius: 5px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        background-color: var(--primary-color);
        color: white;
    }
    
    .btn i.material-icons {
        margin-right: 6px;
        font-size: 18px;
    }
    
    .chart-wrapper {
        flex: 1;
        min-height: 0;
        background-color: white;
        padding: 15px;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    #notification {
        display: none;
        padding: 10px 15px;
        border-radius: 5px;
        margin: 10px auto;
        font-size: 14px;
        font-weight: 500;
        background-color: rgba(229, 0, 5, 0.1);
        color: var(--primary-color);
        text-align: center;
        max-width: 80%;
    }

    .metrics-container {
        margin-top: 15px;
        font-size: 13px;
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
        gap: 10px;
    }

    .metric-card {
        background: #f8f9fa;
        padding: 8px;
        border-radius: 5px;
        text-align: center;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }

    .metric-name {
        font-weight: 600;
        color: var(--secondary-color);
    }

    .metric-value {
        font-weight: bold;
        color: var(--primary-color);
    }
</style>

<div class="compact-container">
    <h1>Importance des Colonnes</h1>

    <div id="notification"></div>

    <div class="control-row">
        <label for="model-key">Modèle :</label>
        <select id="model-key">
            <option value="situation_familiale">Situation Familiale</option>
            <option value="situation_professionnelle">Situation Professionnelle</option>
            <option value="situation_financiere">Situation Financière</option>
            <option value="capacite_remboursement">Capacité Remboursement</option>            
            <option value="inspection_environnement">Inspection Environnement</option>
        </select>
        
        <button id="load-button" class="btn">
            <i class="material-icons">insert_chart</i> Charger
        </button>
    </div>

    <div class="chart-wrapper">
        <canvas id="feature-chart"></canvas>
    </div>

    <div id="metrics-display" class="metrics-container" style="display: none;"></div>
</div>

<script>
    const loadButton = document.getElementById('load-button');
    const featureChart = document.getElementById('feature-chart').getContext('2d');
    const notification = document.getElementById('notification');
    const metricsDisplay = document.getElementById('metrics-display');
    let chart = null;

    function resizeChart() {
        const canvas = document.getElementById('feature-chart');
        const container = document.querySelector('.chart-wrapper');
        canvas.width = container.clientWidth;
        canvas.height = container.clientHeight;
        if (chart) chart.update();
    }

    window.addEventListener('load', resizeChart);
    window.addEventListener('resize', resizeChart);

    function showNotification(message, isError = false) {
        notification.textContent = message;
        notification.style.backgroundColor = isError ? 'rgba(244, 67, 54, 0.1)' : 'rgba(76, 175, 80, 0.1)';
        notification.style.color = isError ? '#f44336' : '#4CAF50';
        notification.style.display = 'block';
        setTimeout(() => {
            notification.style.display = 'none';
        }, 3000);
    }

    function displayMetrics(metrics) {
        metricsDisplay.innerHTML = '';
        metricsDisplay.style.display = 'grid';
        
        for (const [name, value] of Object.entries(metrics)) {
            const metricCard = document.createElement('div');
            metricCard.className = 'metric-card';
            metricCard.innerHTML = `
                <div class="metric-name">${name.replace('_', ' ')}</div>
                <div class="metric-value">${value?.toFixed?.(4) || 'N/A'}</div>
            `;
            metricsDisplay.appendChild(metricCard);
        }
    }

    loadButton.addEventListener('click', async () => {
        const modelKey = document.getElementById('model-key').value;
        loadButton.disabled = true;
        loadButton.innerHTML = `<i class="material-icons">hourglass_empty</i> Chargement...`;

        try {
            const response = await fetch(`/get-feature-importances?model_key=${modelKey}`);
            const data = await response.json();
            
            if (!data.data) {
                throw new Error("Format de données inattendu");
            }

            // Extraire les features et importances
            const features = data.data.map(item => item.feature);
            const importances = data.data.map(item => item.importance);
            
            updateChart(features, importances);
            
            // Afficher les métriques si elles existent
            if (data.metrics) {
                displayMetrics(data.metrics);
            }
            
            showNotification("Données chargées avec succès");
        } catch (error) {
            console.error("Erreur:", error);
            showNotification(`Erreur: ${error.message}`, true);
        } finally {
            loadButton.disabled = false;
            loadButton.innerHTML = `<i class="material-icons">insert_chart</i> Charger`;
        }
    });

    function updateChart(features, importances) {
        const formattedFeatures = features.map(f => 
            f.replace(/_/g, ' ')
             .replace(/\b\w/g, l => l.toUpperCase())
        );

        if (chart) chart.destroy();

        chart = new Chart(featureChart, {
            type: 'bar',
            data: {
                labels: formattedFeatures,
                datasets: [{
                    data: importances,
                    backgroundColor: 'rgba(229, 0, 5, 0.7)',
                    borderColor: 'rgba(229, 0, 5, 1)',
                    borderWidth: 1,
                    borderRadius: 3
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        callbacks: {
                            label: ctx => `Importance: ${ctx.raw.toFixed(4)}`
                        }
                    }
                },
                scales: {
                    y: { 
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: "Valeur d'importance"
                        }
                    },
                    x: { 
                        ticks: {
                            autoSkip: true,
                            maxRotation: 45,
                            minRotation: 45,
                            font: { size: 10 }
                        },
                        title: {
                            display: true,
                            text: "Colonnes"
                        }
                    }
                }
            }
        });
    }
</script>
{% endblock %}